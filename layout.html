{#
    calliope/layout.html
    ~~~~~~~~~~~~~~~~~~~~

    Master layout template for Calliope themes.

    :copyright: Copyright (c) 2012 Quildreen Motta.
    :licence:   MIT, see LICENCE for details.
#}
{% extends "basic/layout.html" %}

{% block doctype %}
<!DOCTYPE html>
{% endblock %}

{%- set reldelim1 = ' › ' %}

{# We don't want no related bars #}
{% block relbar1 %}{% endblock %}
{% block relbar2 %}{% endblock %}
{% block sidebarlogo %}{% endblock %}

{# The project's header #}
{% block header %}
   <div id="header">
     <h1 class="project-name">
       <a href="{{ pathto(master_doc) }}">
         {% if logo == '' %}
           {{ project }}
         {% else %}
           <img src="{{ pathto('_static/' + logo, 1) }}" alt="{{ project }}">
         {% endif %}
       </a>
     </h1>
     <div class="project-version">version {{ release }}</div>
     <div class="chapter-wrapper">
       <h2 class="chapter">
         {%- for parent in parents %}
           <a href="{{ parent.link|e }}"
              {%- if loop.last %}{{ accesskey("U") }}{% endif %}
              >{{ parent.title }}</a>
           {{ reldelim1 }}
         {%- endfor %}              
         {{ title }}
       </h2>
     </div>
   </div>
{% endblock %}

{# Footer presents related links #}
{% block footer %}
 <div id="footer">
   <span class="copy-info">
     {% if show_copyright %}
       {% block copyright %}
         Made with <span class="heart">♥</span> by {{ copyright }}
       {% endblock %}
     {% endif %}
   </span>
   <span class="gen-info">
     {% if show_sphinx %}
       {% block show_sphinx %}
         {% trans sphinx_version=sphinx_version|e %}
           <a href="http://sphinx.pocoo.org/">
             Sphinx
           </a> 
           {{ sphinx_version }}
         {% endtrans %}
       {% endblock %}
     {% endif %}
   </span>
   <div class="additional-footer">
     {% block additional_footer %}{{ theme_licence }}{% endblock %}
   </div>
 </div>

<script>
void function($) {
  var sidebar   = $('.sphinxsidebar')
  var sidebar_y = sidebar.offset().top
  var toc       = []

  // Computes the amount of space to leave for the sidebar
  // :: () -> Number
  function breath() {
    return Math.max(0, (window.scrollY + window.innerHeight) - $('#footer').offset().top) + 40
  }


  // Maps a reference to a (referedOffset, referee) tuple
  // with_distance :: jQuery -> [Number, jQuery]
  function with_distance(e) {
    return { offset: $($(e).attr('href')).offset().top
           , item:   $(e) } }

  // Highlights the current active topic, based on the given offset
  // highlight_current_topic :: [(Number, jQuery)], Number -> ()
  function highlight_current_topic(topics, offset) {
    var active = topics[0]?  topics[0].item : $()
    topics.forEach(function(e){ e.item.removeClass('active') })
    topics.every(function(e) {
      if (e.offset <= offset)  return active = e.item  })
    active.addClass('active') }

  // Normalises the sidebar positioning for readability depending on the offset
  // normalise_sidebar :: Number, Number, Number -> ()
  function normalise_sidebar(offset, height, breath) {
    if (offset > sidebar_y)
      sidebar.css({ position: 'fixed'
                  , top: '10px'
                  , height: height - breath()
                  , width: '210px' })
    else
      sidebar.css({ position: 'static'
                  , top: 'auto'
                  , height: 'auto'
                  , width: '200px' })}
                      

  $(window).bind('scroll', function() {
    normalise_sidebar(window.scrollY, window.innerHeight, breath)
    highlight_current_topic(toc, window.scrollY)
  })

  $(window).bind('resize', function() {
    if (sidebar.css('position') == 'fixed')
      sidebar.height(window.innerHeight - breath())
  })

  $(window).bind('load', function() {
    toc = $('.sphinxsidebar #toc ul ul a.reference.internal').toArray()
                                                             .map(with_distance) })

}(jQuery)
</script>
{% endblock %}

{%- block content %}
  {%- block sidebar1 %} {# possible location for sidebar #} {% endblock %}

    <div class="document">
  {%- block document %}
      <div class="documentwrapper">
      {%- if render_sidebar %}
        <div class="bodywrapper">
      {%- endif %}
          <div class="body">
            {% block body %} {% endblock %}

            {% if pagename != "index" %}
            <div class="chapter-navigation">
              {% if prev %}<a href="{{ prev.link|e }}" title="{{ _('previous chapter') }}" class="previous"{{ accesskey("P") }}>
                 {{ prev.title }}
              </a>{% endif %}{% if next %}<a href="{{ next.link|e }}" title="{{ _('next chapter') }}" class="next" {{ accesskey("N") }}>
                {{ next.title }}
              </a>
              {% endif %}
            </div>
            {% endif %}
          </div>
      {%- if render_sidebar %}
        </div>
      {%- endif %}
      </div>
  {%- endblock %}

  {%- block sidebar2 %}{{ sidebar() }}{% endblock %}
      <div class="clearer"></div>
    </div>
{%- endblock %}
